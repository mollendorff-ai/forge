# Forge Roadmap
# Version: Cargo.toml | History: CHANGELOG.md | Config: project.yaml

# ═══════════════════════════════════════════════════════════════════════════════
# CURRENT - No active milestone
# ═══════════════════════════════════════════════════════════════════════════════

current:
  version: "9.9.3"
  status: completed
  summary: "E2E Test Fixes - COLUMNS, DATEDIF, TRIM, table validation - see CHANGELOG.md"

# ═══════════════════════════════════════════════════════════════════════════════
# NEXT - Candidate milestones (pick one to start)
# ═══════════════════════════════════════════════════════════════════════════════

next:
  # v9.8.0 E2E Test Migration - COMPLETED (see CHANGELOG.md)
  # v9.8.1 Cleanup - e2e tests deleted from forge, pedantic linting in Cargo.toml
  # v9.9.1 Monte Carlo Fix - COMPLETED (see CHANGELOG.md)
  # v9.9.2 Excel Export for Scalar Models - COMPLETED (see CHANGELOG.md)

  # ─────────────────────────────────────────────────────────────────────────────
  # CRITICAL: E2E Test Failures - 49 failing in forge-e2e --forge mode
  # Source: forge-e2e v0.8.0 (ZERO skips, all tests run)
  # ─────────────────────────────────────────────────────────────────────────────

  - version: "9.9.3"
    priority: CRITICAL
    status: completed
    summary: "Fix E2E Test Failures (49→40, fixed 33 tests)"
    source: "forge-e2e --forge --all"
    test_command: "cd ../forge-e2e && FORGE_BIN=/path/to/forge ./target/release/forge-e2e --forge --all"
    results: "602 passed, 40 failed (was: 569 passed, 49 failed)"
    remaining_failures: |
      Most remaining 40 failures are forge-e2e test file issues:
      - Test files using undefined functions (D, GCD, FACT)
      - Test files with wrong argument counts (XIRR, PERCENTILE, COUNTUNIQUE)
      - Features not supported by forge calculate (scenarios, MC functions)
      - Expected behavior differences (floating point epsilon comparison)
    bugs:
      - id: "FORGE-001"
        title: "Boolean equality with numbers"
        severity: CRITICAL
        status: verified_working
        tests_failing: 0
        note: "Already works correctly - TRUE=1 returns TRUE"

      - id: "FORGE-003"
        title: "DATEDIF Y and YD calculation errors"
        severity: CRITICAL
        status: fixed
        tests_failing: 0
        fix: |
          - Y unit: Now counts only complete years (checks anniversary date)
          - YD unit: Calculates days since last anniversary correctly
          - MD unit: Uses actual days in previous month, not fixed 30
          - YM unit: Adjusts for incomplete months
        file: "src/core/array_calculator/evaluator/dates.rs"

      - id: "FORGE-004"
        title: "COLUMNS(table) returns 1 instead of column count"
        severity: HIGH
        status: fixed
        tests_failing: 0
        fix: "COLUMNS now checks if argument is a table reference and returns column count"
        file: "src/core/array_calculator/evaluator/lookup.rs"

      - id: "FORGE-005"
        title: "Table validation rejects valid test data"
        severity: HIGH
        status: fixed
        tests_failing: 0
        fix: |
          Deferred column length validation to calculation time.
          Only validates when row formulas are present (row-wise operations).
          Tables with independent columns (used as separate arrays) now load correctly.
        files_fixed:
          - "src/parser/mod.rs"
          - "src/cli/commands/mod.rs"
          - "src/core/array_calculator/mod.rs"

      - id: "FORGE-TRIM"
        title: "TRIM doesn't collapse internal spaces"
        severity: MEDIUM
        status: fixed
        tests_failing: 0
        fix: "TRIM now collapses multiple internal spaces to single space (Excel behavior)"
        file: "src/core/array_calculator/evaluator/text.rs"

  # ─────────────────────────────────────────────────────────────────────────────
  # Performance Milestones
  # ─────────────────────────────────────────────────────────────────────────────

  - version: "10.0.0"
    priority: NORMAL
    status: pending
    summary: "Performance - SIMD Vectorization"
    deliverables:
      - "Identify hot paths in Monte Carlo, Bootstrap, matrix operations"
      - "Use packed_simd or std::simd for parallel arithmetic"
      - "Benchmark before/after with criterion"
      - "Target: 2-4x speedup on numeric-heavy workloads"

  - version: "10.1.0"
    priority: NORMAL
    status: pending
    summary: "Performance - Multi-threading with Rayon"
    deliverables:
      - "Parallelize Monte Carlo iterations across cores"
      - "Parallelize Bootstrap resampling"
      - "Parallelize independent table calculations"
      - "Target: Near-linear scaling with core count"

  - version: "10.2.0"
    priority: NORMAL
    status: pending
    summary: "Performance - GPU Acceleration (CUDA/OpenCL)"
    deliverables:
      - "Evaluate rust-cuda or ocl crate"
      - "Offload Monte Carlo to GPU"
      - "Offload matrix operations to GPU"
      - "Optional feature flag (--features gpu)"
      - "Target: 10-100x for large simulations"

  - version: "10.3.0"
    priority: NORMAL
    status: pending
    summary: "Performance - Algorithmic Optimizations"
    deliverables:
      - "Profile all functions with flamegraph"
      - "Identify O(n²) or worse algorithms"
      - "Optimize memory allocations (arena allocators)"
      - "Cache repeated calculations"
      - "Target: 2-10x from algorithmic improvements"

  # ─────────────────────────────────────────────────────────────────────────────
  # DANEEL Integration - Crystal Analysis for Alignment Monitoring
  # See ADR-028-CRYSTAL-ANALYSIS.md
  # ─────────────────────────────────────────────────────────────────────────────

  - version: "10.4.0"
    priority: HIGH
    status: pending
    summary: "Crystal Analysis - N-Dimensional Fractal Visualization for DANEEL"
    adr: "ADR-028-CRYSTAL-ANALYSIS.md"
    origin: "Grok (SuperGrok) + Rex - Dec 21, 2025"
    description: |
      Four Laws as embedded vectors ("Law Crystals") in embedding space.
      Thoughts clustering near Law Crystals = caring emerging, quantifiable.
      PCA/UMAP reduce to 3D for TUI visualization.
    dependencies:
      - "linfa = 0.7 (PCA, dimensionality reduction)"
      - "linfa-reduction = 0.7"
      - "candle-core = 0.3 (local embeddings, no GPU)"
      - "candle-transformers = 0.3 (all-MiniLM-L6-v2)"
      - "qdrant-client = 1.0"
    tasks:
      - id: "CRYSTAL-1"
        title: "Add ML/embedding dependencies"
        status: pending
        file: "Cargo.toml"

      - id: "CRYSTAL-2"
        title: "Create src/crystals.rs module"
        status: pending
        description: "Law Crystals as fixed embedding vectors, alignment distance"
        files: ["src/crystals.rs", "src/lib.rs"]

      - id: "CRYSTAL-3"
        title: "Add /fractal endpoint to API"
        status: pending
        description: "Sample Qdrant, PCA reduce, calculate alignment score"
        file: "src/api/handlers.rs"

      - id: "CRYSTAL-4"
        title: "Alignment score + Monte Carlo drift"
        status: pending
        description: "Variance of distances to centroid, drift risk projection"
        file: "src/crystals.rs"

      - id: "CRYSTAL-5"
        title: "CLI command: forge fractal"
        status: pending
        description: "CLI interface with --watch mode"
        file: "src/cli/mod.rs"
    deliverables:
      - "POST /fractal endpoint returning alignment score + 3D points"
      - "forge fractal CLI command with JSON output"
      - "Law Crystals embedded at boot (all-MiniLM-L6-v2)"
      - "Monte Carlo drift risk projection"
      - "Unit tests for alignment calculation"

  - version: "9.9.0"
    priority: HIGH
    status: pending
    summary: "Port edge cases from forge-e2e to inline Rust unit tests"
    deliverables:
      - "Port edge cases from ../forge-e2e/tests/ to inline unit tests"
      - "Add tests in appropriate src/ modules (Rust way - #[cfg(test)] mod tests)"
      - "Verify all edge cases pass"
      - "Update test count in --help header"

  - version: "7.3.0"
    priority: NORMAL
    status: pending
    summary: "INCLUDE Feature - Complete E2E Testing & Roundtrip Validation"
    deliverables:
      - "E2E test: YAML -> XLSX -> Gnumeric -> CSV roundtrip with includes"
      - "E2E test: 3+ level recursive includes (main->level1->level2->level3)"
      - "E2E test: @namespace.field formula evaluation"
      - "E2E test: Circular dependency detection"
      - "Documentation: INCLUDE feature limitations"

# ═══════════════════════════════════════════════════════════════════════════════
# BACKLOG - Future ideas (unscheduled)
# ═══════════════════════════════════════════════════════════════════════════════

backlog:
  - "Find external FOSS tool to validate Forge-native functions"
  - "Enterprise licensing (when ready to leave CGI)"
  - "MCP server documentation"
  - "Performance benchmarks per function"
  - "FPGA acceleration for HFT (post-capitalization) - see ADR-026"

# ═══════════════════════════════════════════════════════════════════════════════
# BUGS - Active issues
# ═══════════════════════════════════════════════════════════════════════════════

bugs:
  - id: "FORGE-MC-001"
    title: "Monte Carlo dependent formula evaluation broken"
    severity: CRITICAL
    status: fixed
    fixed_in: "9.9.1"
    blocking: "DANEEL paper probabilistic analysis"
    description: |
      forge simulate samples MC.* functions correctly but doesn't propagate
      sampled values through dependent formulas. All downstream calculations
      return 0.0 instead of computed values.
    fix: |
      Changed simulate command to use run_with_evaluator() instead of run().
      Each iteration now: substitutes sampled values -> runs ArrayCalculator
      -> extracts computed outputs. Added regression test.
    reporter: "daneel-models/game-theory-asi-race-mc.yaml"
    date: "2025-12-17"
    fixed_date: "2025-12-17"

# BUG-001 through BUG-013 fixed
# BUG-010 to BUG-013 were already resolved by BUG-003 to BUG-009 fixes (Boolean literals, comparisons)
# See CHANGELOG.md for details

# ═══════════════════════════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════════════════════════

summary:
  total_functions: 173
  categories: 15
  unit_tests: 1956
  history: "See CHANGELOG.md"
